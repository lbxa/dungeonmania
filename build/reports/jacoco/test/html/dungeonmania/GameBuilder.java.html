<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GameBuilder.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">assignment-ii</a> &gt; <a href="index.source.html" class="el_package">dungeonmania</a> &gt; <span class="el_source">GameBuilder.java</span></div><h1>GameBuilder.java</h1><pre class="source lang-java linenums">package dungeonmania;

import java.io.IOException;

import org.json.JSONObject;

import dungeonmania.entities.Entity;
import dungeonmania.entities.EntityFactory;
import dungeonmania.entities.Player;
import dungeonmania.goals.Goal;
import dungeonmania.goals.GoalFactory;
import dungeonmania.map.GameMap;
import dungeonmania.map.GraphNode;
import dungeonmania.map.GraphNodeFactory;
import dungeonmania.util.FileLoader;

/**
 * GameBuilder -- A builder to build up the whole game
 * @author      Webster Zhang
 * @author      Tina Ji
 */
<span class="fc" id="L22">public class GameBuilder {</span>
    private String configName;
    private String dungeonName;

    private JSONObject config;
    private JSONObject dungeon;

    public GameBuilder setConfigName(String configName) {
<span class="fc" id="L30">        this.configName = configName;</span>
<span class="fc" id="L31">        return this;</span>
    }

    public GameBuilder setDungeonName(String dungeonName) {
<span class="fc" id="L35">        this.dungeonName = dungeonName;</span>
<span class="fc" id="L36">        return this;</span>
    }

    public Game buildGame() {
<span class="fc" id="L40">        loadConfig();</span>
<span class="fc" id="L41">        loadDungeon();</span>
<span class="pc bpc" id="L42" title="3 of 4 branches missed.">        if (dungeon == null &amp;&amp; config == null) {</span>
<span class="nc" id="L43">            return null; // something went wrong</span>
        }

<span class="fc" id="L46">        Game game = new Game(dungeonName);</span>
<span class="fc" id="L47">        EntityFactory factory = new EntityFactory(config);</span>
<span class="fc" id="L48">        game.setEntityFactory(factory);</span>
<span class="fc" id="L49">        buildMap(game);</span>
<span class="fc" id="L50">        buildGoals(game);</span>
<span class="fc" id="L51">        game.init();</span>

<span class="fc" id="L53">        return game;</span>
    }

    private JSONObject createJSONEntity(String type, int x, int y) {
<span class="fc" id="L57">        JSONObject o = new JSONObject();</span>
<span class="fc" id="L58">        o.put(&quot;x&quot;, x);</span>
<span class="fc" id="L59">        o.put(&quot;y&quot;, y);</span>
<span class="fc" id="L60">        o.put(&quot;type&quot;, type);</span>
<span class="fc" id="L61">        return o;</span>
    }

    public Game genRandomGame(int xStart, int yStart, int xEnd, int yEnd) {
<span class="fc" id="L65">        loadConfig();</span>
<span class="pc bpc" id="L66" title="1 of 2 branches missed.">        if (config == null) {</span>
<span class="nc" id="L67">            return null; // something went wrong</span>
        }

<span class="fc" id="L70">        Game game = new Game(dungeonName);</span>
<span class="fc" id="L71">        EntityFactory factory = new EntityFactory(config);</span>
<span class="fc" id="L72">        game.setEntityFactory(factory);</span>

<span class="fc" id="L74">        GameMap map = new GameMap();</span>
<span class="fc" id="L75">        map.setGame(game);</span>

<span class="fc" id="L77">        addPlayer(game, map, xStart, yStart);</span>
<span class="fc" id="L78">        addWalls(game, map, xStart, yStart, xEnd, yEnd);</span>
<span class="fc" id="L79">        addExit(game, map, xEnd, yEnd);</span>

<span class="fc" id="L81">        game.setMap(map);</span>

<span class="fc" id="L83">        addExitGoal(game, map);</span>
<span class="fc" id="L84">        game.init();</span>

<span class="fc" id="L86">        return game;</span>
    }

    private void loadConfig() {
<span class="fc" id="L90">        String configFile = String.format(&quot;/configs/%s.json&quot;, configName);</span>
        try {
<span class="fc" id="L92">            config = new JSONObject(FileLoader.loadResourceFile(configFile));</span>
<span class="nc" id="L93">        } catch (IOException e) {</span>
<span class="nc" id="L94">            e.printStackTrace();</span>
<span class="nc" id="L95">            config = null;</span>
<span class="fc" id="L96">        }</span>
<span class="fc" id="L97">    }</span>

    private void loadDungeon() {
<span class="fc" id="L100">        String dungeonFile = String.format(&quot;/dungeons/%s.json&quot;, dungeonName);</span>
        try {
<span class="fc" id="L102">            dungeon = new JSONObject(FileLoader.loadResourceFile(dungeonFile));</span>
<span class="nc" id="L103">        } catch (IOException e) {</span>
<span class="nc" id="L104">            dungeon = null;</span>
<span class="fc" id="L105">        }</span>
<span class="fc" id="L106">    }</span>

    private void buildMap(Game game) {
<span class="fc" id="L109">        GameMap map = new GameMap();</span>
<span class="fc" id="L110">        map.setGame(game);</span>

<span class="fc" id="L112">        dungeon.getJSONArray(&quot;entities&quot;).forEach(e -&gt; {</span>
<span class="fc" id="L113">            JSONObject jsonEntity = (JSONObject) e;</span>
<span class="fc" id="L114">            GraphNode newNode = GraphNodeFactory.createEntity(jsonEntity, game.getEntityFactory());</span>
<span class="fc" id="L115">            Entity entity = newNode.getEntities().get(0);</span>

<span class="pc bpc" id="L117" title="1 of 2 branches missed.">            if (newNode != null)</span>
<span class="fc" id="L118">                map.addNode(newNode);</span>

<span class="fc bfc" id="L120" title="All 2 branches covered.">            if (entity instanceof Player)</span>
<span class="fc" id="L121">                map.setPlayer((Player) entity);</span>
<span class="fc" id="L122">        });</span>
<span class="fc" id="L123">        game.setMap(map);</span>
<span class="fc" id="L124">    }</span>

    private void addWalls(Game game, GameMap map, int xStart, int yStart, int xEnd, int yEnd) {
<span class="fc" id="L127">        DungeonGenerator dg = new DungeonGenerator(xStart, yStart, xEnd, yEnd);</span>
<span class="fc" id="L128">        boolean[][] walls = dg.randomizedPrims();</span>

<span class="fc bfc" id="L130" title="All 2 branches covered.">        for (int col = 0; col &lt; walls.length; col++) {</span>
<span class="fc bfc" id="L131" title="All 2 branches covered.">            for (int row = 0; row &lt; walls[0].length; row++) {</span>
<span class="fc bfc" id="L132" title="All 2 branches covered.">                if (!walls[col][row]) {</span>
<span class="fc" id="L133">                    JSONObject wall = createJSONEntity(&quot;wall&quot;, row + xStart - 1, col + yStart - 1);</span>
<span class="fc" id="L134">                    GraphNode newNode = GraphNodeFactory.createEntity(wall, game.getEntityFactory());</span>
<span class="pc bpc" id="L135" title="1 of 2 branches missed.">                    if (newNode != null) map.addNode(newNode);</span>
                }
            }
        }
<span class="fc" id="L139">    }</span>

    private void addPlayer(Game game, GameMap map, int x, int y) {
<span class="fc" id="L142">        JSONObject playerJSON = createJSONEntity(&quot;player&quot;, x, y);</span>
<span class="fc" id="L143">        GraphNode newPlayerNode = GraphNodeFactory.createEntity(playerJSON, game.getEntityFactory());</span>
<span class="fc" id="L144">        Entity player = newPlayerNode.getEntities().get(0);</span>
<span class="fc" id="L145">        map.addNode(newPlayerNode);</span>
<span class="fc" id="L146">        map.setPlayer((Player) player);</span>
<span class="fc" id="L147">    }</span>

    private void addExit(Game game, GameMap map, int x, int y) {
<span class="fc" id="L150">        JSONObject exit = createJSONEntity(&quot;exit&quot;, x, y);</span>
<span class="fc" id="L151">        GraphNode newNode = GraphNodeFactory.createEntity(exit, game.getEntityFactory());</span>
<span class="fc" id="L152">        map.addNode(newNode);</span>
<span class="fc" id="L153">    }</span>

    public void buildGoals(Game game) {
<span class="pc bpc" id="L156" title="1 of 2 branches missed.">        if (!dungeon.isNull(&quot;goal-condition&quot;)) {</span>
<span class="fc" id="L157">            Goal goal = GoalFactory.createGoal(dungeon.getJSONObject(&quot;goal-condition&quot;), config);</span>
<span class="fc" id="L158">            game.setGoals(goal);</span>
        }
<span class="fc" id="L160">    }</span>

    private void addExitGoal(Game game, GameMap map) {
<span class="fc" id="L163">        JSONObject exitGoal = new JSONObject();</span>
<span class="fc" id="L164">        exitGoal.put(&quot;goal&quot;, &quot;exit&quot;);</span>
<span class="fc" id="L165">        Goal goal = GoalFactory.createGoal(exitGoal, config);</span>
<span class="fc" id="L166">        game.setGoals(goal);</span>
<span class="fc" id="L167">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>